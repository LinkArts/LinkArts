<div class="all">
    <div class="main-wrapper">
        <aside class="sidebar">
            <a href="#" data-section="dashboard-section" class="nav-link active">Dashboard</a>
            <a href="#" data-section="user-management-section" class="nav-link">Usuários</a>
            <a href="#" data-section="content-management-section" class="nav-link">Conteúdo</a>
            <a href="#" data-section="service-management-section" class="nav-link">Serviços</a>
            <a href="#" data-section="complaints-section" class="nav-link">Denúncias</a>
        </aside>

        <main class="content-area">
            <section id="dashboard-section" class="content-section active">
                <h2>Visão Geral</h2>
                <div class="list-container">
                    <h3>Total de Usuários</h3>
                    <div class="metrics-grid" id="total-users-metrics">
                    </div>
                </div>

                <div class="list-container">
                    <h3>Estatísticas Gerais da Plataforma</h3>
                    <div class="metrics-grid" id="general-statistics-metrics">
                    </div>
                </div>

                <div class="list-container">
                    <div class="recent-section-content">
                        <div class="column-list">
                            <h3>Últimos Usuários Cadastrados</h3>
                            <table class="styled-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Data de Criação</th>
                                        <th>Hora de Criação</th>
                                    </tr>
                                </thead>
                                <tbody id="last-registered-users"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="user-management-section" class="content-section">
                <h2>Gerenciamento de Usuários</h2>
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-tbody">
                    </tbody>
                </table>
            </section>

            <section id="content-management-section" class="content-section">
                <h2>Gerenciamento de Conteúdo</h2>

                <div class="list-container">
                    <h3>Músicas, Álbuns e Eventos</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="value" id="total-music-count">0</div>
                            <div class="label">Total de Músicas</div>
                        </div>
                        <div class="metric-card">
                            <div class="value" id="total-albums-count">0</div>
                            <div class="label">Total de Álbuns</div>
                        </div>
                        <div class="metric-card">
                            <div class="value" id="total-events-count">0</div>
                            <div class="label">Total de Eventos</div>
                        </div>
                    </div>
                    <h3 style="margin-top: 2rem;">Lista de Músicas</h3>
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Artista</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="music-list-tbody">
                        </tbody>
                    </table>
                    <h3 style="margin-top: 2rem;">Lista de Álbuns</h3>
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Artista</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="album-list-tbody">
                        </tbody>
                    </table>
                    <h3 style="margin-top: 2rem;">Lista de Eventos</h3>
                    <table class="styled-table" style="margin-top: 2rem;">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Estabelecimento</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="events-list-tbody">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="service-management-section" class="content-section">
                <h2>Gerenciamento de Serviços</h2>
                <div class="list-container">
                    <h3>Pedidos, Propostas e Serviços Agendados</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="value" id="total-requests-count">0</div>
                            <div class="label">Total de Pedidos de Serviço</div>
                        </div>
                        <div class="metric-card">
                            <div class="value" id="total-proposals-count">0</div>
                            <div class="label">Total de Propostas de Serviço</div>
                        </div>
                        <div class="metric-card">
                            <div class="value" id="total-services-count">0</div>
                            <div class="label">Total de Serviços Agendados</div>
                        </div>
                    </div>
                    <h3>Pedidos de Serviço</h3>
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Estabelecimento</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="service-requests-tbody">
                        </tbody>
                    </table>
                </div>

                <div class="list-container" style="margin-top: 3rem;">
                    <h3>Propostas de Serviço</h3>
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Artista</th>
                                <th>Estabelecimento</th>
                                <th>Status</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="service-proposals-tbody">
                        </tbody>
                    </table>
                </div>

                <div class="list-container" style="margin-top: 3rem;">
                    <h3>Serviços Agendados</h3>
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Artista</th>
                                <th>Estabelecimento</th>
                                <th>Status</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="service-agenda-tbody">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="complaints-section" class="content-section">
                <h2>Gerenciamento de Denúncias</h2>
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Denunciado</th>
                            <th>Tipo</th>
                            <th>Motivo</th>
                            <th>Descrição</th>
                            <th>Status</th>
                            <th>Data de Criação</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="complaints-list-tbody">
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <div class="modal-overlay" id="details-view-modal-overlay">
        <div class="modal" id="details-view-modal">
            <div class="modal-header">
                <h2 id="modal-title">Detalhes</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-body-content">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary modal-close-btn">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () =>
    {
        const totalUsers = await fetch('/admin/usuarios').then(data => data.json())
        const detailedStats = await fetch('/admin/stats').then(data => data.json())
        const recentUsers = await fetch('/admin/usuarios-recentes').then(data => data.json())
        const allUsers = await fetch('/admin/todos-usuarios').then(data => data.json());
        const allMusics = await fetch('/admin/musicas').then(data => data.json());
        const allAlbums = await fetch('/admin/albuns').then(data => data.json());
        const allEvents = await fetch('/admin/eventos').then(data => data.json());
        const allServiceRequests = await fetch('/admin/pedidos-servico').then(data => data.json());
        const allServiceProposals = await fetch('/admin/propostas-servico').then(data => data.json());
        const allServices = await fetch('/admin/servicos').then(data => data.json());
        const allComplaints = await fetch('/admin/denuncias').then(data => data.json());

        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');

        const detailsViewModalOverlay = document.getElementById('details-view-modal-overlay');
        const detailsViewModal = document.getElementById('details-view-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBodyContent = document.getElementById('modal-body-content');
        const modalCloseBtns = detailsViewModal.querySelectorAll('.modal-close-btn');

        function openModal(title, contentHtml)
        {
            modalTitle.textContent = title;
            modalBodyContent.innerHTML = contentHtml;
            detailsViewModalOverlay.classList.add('active');
        }

        function closeModal()
        {
            modalTitle.textContent = '';
            modalBodyContent.innerHTML = '';
            detailsViewModalOverlay.classList.remove('active');
        }

        modalCloseBtns.forEach(btn =>
        {
            btn.addEventListener('click', closeModal);
        });
        detailsViewModalOverlay.addEventListener('click', (e) =>
        {
            if (e.target === detailsViewModalOverlay)
            {
                closeModal();
            }
        });

        function renderDashboardOverview()
        {
            const totalUsersContainer = document.getElementById('total-users-metrics');
            const { artists, establishments, total } = totalUsers;
            totalUsersContainer.innerHTML = `
                    <div class="metric-card">
                        <div class="value">${ artists }</div>
                        <div class="label">Artistas</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">${ establishments }</div>
                        <div class="label">Estabelecimentos</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">${ total }</div>
                        <div class="label">Total de Usuários</div>
                    </div>
                `;

            const lastRegisteredUsersList = document.getElementById('last-registered-users');
            lastRegisteredUsersList.innerHTML = '';
            recentUsers.forEach(user =>
            {
                const lastRegisteredUsersTable = document.getElementById('last-registered-users');
                lastRegisteredUsersTable.innerHTML = '';
                recentUsers.forEach(user =>
                {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${ user.name }</td>
                        <td>${ user.type }</td>
                        <td>${ user.date }</td>
                        <td>${ user.time }</td>
                    `;
                    lastRegisteredUsersTable.appendChild(tr);
                });
            });

            const generalStatsContainer = document.getElementById('general-statistics-metrics');
            const { musics, albums, events, serviceRequests, services, concludedServices, cancelledServices } = detailedStats;
            generalStatsContainer.innerHTML = `
                    <div class="metric-card">
                        <div class="value">${ musics }</div>
                        <div class="label">Músicas</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">${ albums }</div>
                        <div class="label">Álbuns</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">${ events }</div>
                        <div class="label">Eventos</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">${ services }</div>
                        <div class="label">Serviços</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">${ concludedServices }</div>
                        <div class="label">Serviços Concluídos</div>
                    </div>
                    <div class="metric-card">
                        <div class="value">${ cancelledServices }</div>
                        <div class="label">Serviços Cancelados</div>
                    </div>
                `;
        }

        function renderUserManagement()
        {
            const userListBody = document.getElementById('user-list-tbody');
            userListBody.innerHTML = '';
            allUsers.forEach(user =>
            {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${ user.name }</td>
                        <td>${ user.email }</td>
                        <td>${ user.type }</td>
                        <td><span style="color:${ user.isSuspended ? '#dc3545' : '#28a745' };">${ user.isSuspended ? 'Suspenso' : 'Ativo' }</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn ${ !user.isSuspended ? 'btn-danger' : 'btn-success' }" data-action="toggle-status" data-id="${ user.id }">
                                    ${ !user.isSuspended ? 'Suspender' : 'Liberar' }
                                </button>
                                <a href="/profile/${ user.id }" class="btn btn-info" data-action="view-details" data-id="${ user.id }" data-type="user">Ver Perfil</a>
                            </div>
                        </td>
                    `;
                userListBody.appendChild(tr);
            });

            userListBody.querySelectorAll('[data-action="toggle-status"]').forEach(button =>
            {
                button.addEventListener('click', async (e) =>
                {
                    const userId = e.target.dataset.id;
                    const user = allUsers.find(u => u.id == userId);
                    if (user)
                    {
                        const response = await fetch(`/admin/suspender-usuario/${userId}`, {
                            method: 'PUT'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            user.isSuspended = data.isSuspended;
                            renderUserManagement();
                        } else {
                            alert('Erro ao atualizar status do usuário.');
                        }
                    }
                });
            });
            userListBody.querySelectorAll('[data-action="view-details"]').forEach(button =>
            {
                button.addEventListener('click', (e) =>
                {
                    const id = e.target.dataset.id;
                    const user = allUsers.find(item => item.id === id);
                    if (user)
                    {
                        const content = `
                                <p><strong>ID:</strong> ${ user.id }</p>
                                <p><strong>Nome:</strong> ${ user.name }</p>
                                <p><strong>E-mail:</strong> ${ user.email }</p>
                                <p><strong>Tipo:</strong> ${ user.type }</p>
                                <p><strong>Status:</strong> ${ user.isActive ? 'Ativo' : 'Inativo' }</p>
                            `;
                        openModal(`Detalhes do Usuário: ${ user.name }`, content);
                    }
                });
            });
        }

        function renderContentManagement()
        {
            document.getElementById('total-music-count').textContent = allMusics.length;
            document.getElementById('total-albums-count').textContent = allAlbums.length;
            document.getElementById('total-events-count').textContent = allEvents.length;

            const musicListBody = document.getElementById('music-list-tbody');
            musicListBody.innerHTML = '';
            allMusics.forEach(item =>
            {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${ item.title }</td>
                        <td>${ item.artist ?? '-' }</td>
                        <td>${ item.date ?? '-' }</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" data-action="delete" data-id="${ item.id }" data-type="music">Excluir</button>
                            </div>
                        </td>
                    `;
                musicListBody.appendChild(tr);
            });

            const albumListBody = document.getElementById('album-list-tbody');
            albumListBody.innerHTML = '';
            allAlbums.forEach(item =>
            {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${ item.title }</td>
                        <td>${ item.artist ?? '-' }</td>
                        <td>${ item.date ?? '-' }</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" data-action="delete" data-id="${ item.id }" data-type="album">Excluir</button>
                            </div>
                        </td>
                    `;
                albumListBody.appendChild(tr);
            });

            const eventsListBody = document.getElementById('events-list-tbody');
            eventsListBody.innerHTML = '';
            allEvents.forEach(item =>
            {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${ item.title }</td>
                        <td>${ item.establishment ?? '-' }</td>
                        <td>${ item.date ?? '-' }</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" data-action="delete" data-id="${ item.id }" data-type="album">Excluir</button>
                            </div>
                        </td>
                    `;
                eventsListBody.appendChild(tr);
            });
        }

        function renderServiceManagement()
        {
            document.getElementById('total-requests-count').textContent = allServiceRequests.length;
            document.getElementById('total-proposals-count').textContent = allServiceProposals.length;
            document.getElementById('total-services-count').textContent = allServices.length;

            const serviceRequestsBody = document.getElementById('service-requests-tbody');
            serviceRequestsBody.innerHTML = '';
            allServiceRequests.forEach(item =>
            {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${ item.title }</td>
                        <td>${ item.establishment }</td>
                        <td>${ item.date ?? '-' }</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" data-action="delete" data-id="${ item.id }" data-type="album">Excluir</button>
                            </div>
                        </td>
                    `;
                serviceRequestsBody.appendChild(tr);
            });

            const serviceProposalsBody = document.getElementById('service-proposals-tbody');
            serviceProposalsBody.innerHTML = '';
            allServiceProposals.forEach(item =>
            {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${ item.title }</td>
                        <td>${ item.artist ?? '-' }</td>
                        <td>${ item.establishment ?? '-' }</td>
                        <td>${ item.status ?? '-' }</td>
                        <td>${ item.date ?? '-' }</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" data-action="delete" data-id="${ item.id }" data-type="album">Excluir</button>
                            </div>
                        </td>
                    `;
                serviceProposalsBody.appendChild(tr);
            });

            const serviceAgendaBody = document.getElementById('service-agenda-tbody');
            serviceAgendaBody.innerHTML = '';
            allServices.forEach(item =>
            {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${ item.title }</td>
                        <td>${ item.artist ?? '-' }</td>
                        <td>${ item.establishment ?? '-' }</td>
                        <td>${ item.status ?? '-' }</td>
                        <td>${ item.date ?? '-' }</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger" data-action="delete" data-id="${ item.id }" data-type="album">Excluir</button>
                            </div>
                        </td>
                    `;
                serviceAgendaBody.appendChild(tr);
            });
        }

        function renderComplaints()
        {
            const complaintsListBody = document.getElementById('complaints-list-tbody');
            complaintsListBody.innerHTML = '';
            allComplaints.forEach(item =>
            {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${ item.reported ?? '-' }</td>
                        <td>${ item.type ?? '-' }</td>
                        <td>${ item.reason ?? '-' }</td>
                        <td>${ item.description ?? '-' }</td>
                        <td>${ item.status ?? '-' }</td>
                        <td>${ item.date ? new Date(item.date).toLocaleDateString('pt-BR') : '-' }</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-info" data-action="resolve" data-id="${ item.id }" data-type="complaint">Resolver</button>
                            </div>
                        </td>
                    `;
                complaintsListBody.appendChild(tr);
            });
            complaintsListBody.querySelectorAll('[data-action="view-details"]').forEach(button =>
            {
                button.addEventListener('click', (e) =>
                {
                    const id = e.target.dataset.id;
                    const complaint = allComplaints.find(item => item.id === id);
                    if (complaint)
                    {
                        const content = `
                                <p><strong>ID:</strong> ${ complaint.id }</p>
                                <p><strong>Tipo:</strong> ${ complaint.type }</p>
                                <p><strong>Denunciado:</strong> ${ complaint.reported }</p>
                                <p><strong>Status:</strong> ${ complaint.status }</p>
                                <p><strong>Data:</strong> ${ complaint.date }</p>
                                <p><strong>Detalhes:</strong> ${ complaint.details }</p>
                            `;
                        openModal(`Detalhes da Denúncia: ${ complaint.id }`, content);
                    }
                });
            });
            complaintsListBody.querySelectorAll('[data-action="resolve"]').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = button.dataset.id;
                    if (confirm('Deseja marcar esta denúncia como resolvida?')) {
                        const response = await fetch(`/admin/resolver-denuncia/${id}`, { method: 'PUT' });
                        if (response.ok) {
                            const idx = allComplaints.findIndex(item => item.id == id);
                            if (idx > -1) {
                                allComplaints[idx].status = 'Resolvido';
                                renderComplaints();
                            }
                        } else {
                            alert('Erro ao resolver denúncia.');
                        }
                    }
                });
            });
        }

        function addDeleteListeners() {
            document.querySelectorAll('[data-action="delete"]').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = button.dataset.id;
                    const type = button.dataset.type;

                    let url = '';
                    switch (type) {
                        case 'music':
                            url = `/admin/deletar-musica/${id}`;
                            break;
                        case 'album':
                            url = `/admin/deletar-album/${id}`;
                            break;
                        case 'event':
                            url = `/admin/deletar-evento/${id}`;
                            break;
                        case 'service-request':
                            url = `/admin/deletar-pedido-servico/${id}`;
                            break;
                        case 'service-proposal':
                            url = `/admin/deletar-proposta-servico/${id}`;
                            break;
                        case 'service':
                            url = `/admin/deletar-servico/${id}`;
                            break;
                        default:
                            return;
                    }

                    if (confirm('Tem certeza que deseja excluir este item?')) {
                        const response = await fetch(url, { method: 'DELETE' });
                        if (response.ok) {
                            switch (type) {
                                case 'music':
                                    const musicIdx = allMusics.findIndex(item => item.id == id);
                                    if (musicIdx > -1) allMusics.splice(musicIdx, 1);
                                    renderContentManagement();
                                    break;
                                case 'album':
                                    const albumIdx = allAlbums.findIndex(item => item.id == id);
                                    if (albumIdx > -1) allAlbums.splice(albumIdx, 1);
                                    renderContentManagement();
                                    break;
                                case 'event':
                                    const eventIdx = allEvents.findIndex(item => item.id == id);
                                    if (eventIdx > -1) allEvents.splice(eventIdx, 1);
                                    renderContentManagement();
                                    break;
                                case 'service-request':
                                    const reqIdx = allServiceRequests.findIndex(item => item.id == id);
                                    if (reqIdx > -1) allServiceRequests.splice(reqIdx, 1);
                                    renderServiceManagement();
                                    break;
                                case 'service-proposal':
                                    const propIdx = allServiceProposals.findIndex(item => item.id == id);
                                    if (propIdx > -1) allServiceProposals.splice(propIdx, 1);
                                    renderServiceManagement();
                                    break;
                                case 'service':
                                    const servIdx = allServices.findIndex(item => item.id == id);
                                    if (servIdx > -1) allServices.splice(servIdx, 1);
                                    renderServiceManagement();
                                    break;
                            }
                        } else {
                            alert('Erro ao excluir item.');
                        }
                    }
                });
            });
        }

        const _renderContentManagement = renderContentManagement;
        const _renderServiceManagement = renderServiceManagement;

        renderContentManagement = function() {
            _renderContentManagement();
            addDeleteListeners();
        };

        renderServiceManagement = function() {
            _renderServiceManagement();
            addDeleteListeners();
        };

        const sectionRenderFunctions = {
            'dashboard-section': renderDashboardOverview,
            'user-management-section': renderUserManagement,
            'content-management-section': renderContentManagement,
            'service-management-section': renderServiceManagement,
            'complaints-section': renderComplaints
        };

        function showSection(sectionId)
        {
            contentSections.forEach(section =>
            {
                section.classList.remove('active');
            });

            navLinks.forEach(link =>
            {
                link.classList.remove('active');
            });

            const activeSection = document.getElementById(sectionId);
            if (activeSection)
            {
                activeSection.classList.add('active');
                document.querySelector(`.nav-link[data-section="${ sectionId }"]`).classList.add('active');

                if (sectionRenderFunctions[sectionId])
                {
                    sectionRenderFunctions[sectionId]();
                }
            }
        }

        navLinks.forEach(link =>
        {
            link.addEventListener('click', (e) =>
            {
                e.preventDefault();
                const sectionId = e.target.dataset.section;
                if (sectionId)
                {
                    showSection(sectionId);
                }
            });
        });

        showSection('dashboard-section');
    });
</script>