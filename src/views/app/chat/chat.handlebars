<body>
    <!-- Armazena o ID do usuário logado para uso no JS -->
    <input type="hidden" id="loggedInUserId" value="{{user.id}}">

    <div id="chat-app">
        <!-- Coluna Esquerda - Conversas (Renderizada pelo Handlebars do Servidor) -->
        <div class="users-column" id="users-column">
            <div class="users-header">
                <h2>Conversas</h2>
            </div>
            <div class="users-list" id="users-list-container">
                {{#if chats.length}}
                    {{#each chats}}
                    <!-- Certifique-se que os data attributes estão corretos -->
                    <div class="user-conversation {{#if this.isActive}}active{{/if}}" data-chat-id="{{this.chatId}}" data-other-user-id="{{this.otherUser.id}}" data-other-user-name="{{this.otherUser.name}}">
                        <!-- CORREÇÃO: Removido ../ de randomColor -->
                        <img src="https://via.placeholder.com/40/{{randomColor}}/FFFFFF?text={{this.otherUser.name.[0]}}" alt="{{this.otherUser.name}}" class="user-avatar">
                        <div class="user-info">
                            <div class="user-name-time">
                                <div class="user-name">{{this.otherUser.name}}</div>
                                <!-- CORREÇÃO: Removido ../ de formatDate -->
                                <div class="user-time">{{formatDate this.latestMessage.createdAt}}</div>
                            </div>
                            <div class="last-message">
                                {{#if this.latestMessage}}
                                    {{this.latestMessage.content}}
                                {{else}}
                                    <i>Sem mensagens</i>
                                {{/if}}
                            </div>
                        </div>
                    </div>
                    {{/each}}
                {{else}}
                    <p>Nenhuma conversa encontrada.</p>
                {{/if}}
            </div>
        </div>

        <!-- Coluna Central - Chat (Conteúdo dinâmico via JS) -->
        <div class="chat-column" id="chat-column">
            <div class="chat-header" id="chat-header-container">
                <!-- Conteúdo preenchido por JS -->
                <div class="chat-user">
                    <img src="https://via.placeholder.com/40/cccccc/FFFFFF?text=?" alt="Selecione">
                    <div class="chat-user-info">
                        <h3>Selecione uma conversa</h3>
                    </div>
                </div>
                <button class="report-button" disabled>Reportar conversa</button>
            </div>
            <div class="messages-container" id="messages-container">
                 <!-- Indicador de carregamento -->
                 <div class="loading-indicator" style="display: none; text-align: center; padding: 10px;">Carregando mensagens antigas...</div>
                <p>Selecione uma conversa para ver as mensagens.</p>
            </div>
            <div class="input-area">
                <div class="message-form">
                    <div class="input-container">
                        <textarea class="message-input" placeholder="Selecione uma conversa..." disabled></textarea>
                        <div class="input-buttons">
                            <button class="attachment-button" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                            </button>
                            <button class="send-button" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4 20-7Z"/><path d="M22 2 11 13"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="send-proposal">
                        <button class="proposal-button" disabled>
                            <span class="icon-plus">+</span>
                            Enviar Proposta
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna Direita - Perfil (Será preenchida dinamicamente) -->
        <div class="profile-column" id="profile-column-container">
            <p>Selecione uma conversa para ver o perfil.</p>
        </div>
    </div>

    <!-- Modal de Proposta (Mantido como no original) -->
    <div class="modal" id="proposal-modal">
        <!-- ... conteúdo do modal ... -->
    </div>

    <!-- Notificação Toast (Mantido como no original) -->
    <div class="toast" id="toast"></div>

    <!-- Incluir Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script> 
    <!-- Incluir Handlebars Client-side (Mantido como no original) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>

    <!-- Templates Handlebars para JS (Serão usados pelo JS abaixo) -->
    <!-- Template para renderizar a lista/mensagens individuais -->
    <script id="message-template" type="text/x-handlebars-template">
        {{#if messages.length}}
            {{#each messages}}
            <div class="msg {{#if this.isCurrentUser}}sent{{else}}received{{/if}}" data-message-id="{{this.id}}">
                <div class="message-bubble">{{this.message}}</div>
                <div class="message-time">{{formatTime this.createdAt}}</div>
            </div>
            {{/each}}
        {{else}}
            <p class="no-messages">Nenhuma mensagem ainda. Envie a primeira!</p>
        {{/if}}
    </script>

    <!-- Template para o cabeçalho do chat -->
    <script id="chat-header-template" type="text/x-handlebars-template">
        {{#if otherUser}}
        <div class="chat-user">
            <div class="profile-avatar" style="width:40px;height:40px;background:#eee;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2em;">
                {{#if otherUser.name}}{{otherUser.name.[0]}}{{else}}?{{/if}}
            </div>
            <div class="chat-user-info">
                <h3>{{#if otherUser.name}}{{otherUser.name}}{{else}}Usuário desconhecido{{/if}}</h3>
            </div>
        </div>
        <button class="report-button">Reportar conversa</button>
        {{else}}
        <div class="chat-user">
            <div class="profile-avatar" style="width:40px;height:40px;background:#eee;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2em;">?</div>
            <div class="chat-user-info">
                <h3>Selecione uma conversa</h3>
            </div>
        </div>
        <button class="report-button" disabled>Reportar conversa</button>
        {{/if}}
    </script>

    <!-- Template para o perfil -->
    <script id="profile-template" type="text/x-handlebars-template">
        {{#if otherUser}}
        <div class="profile-header">
            <div class="profile-avatar" style="width:80px;height:80px;background:#eee;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2em;">
                {{#if otherUser.name}}{{otherUser.name.[0]}}{{else}}?{{/if}}
            </div>
            <div class="profile-name">{{#if otherUser.name}}{{otherUser.name}}{{else}}Usuário desconhecido{{/if}}</div>
            <div class="profile-profession">Usuário</div>
            <div class="profile-location">Localização não informada</div>
        </div>
        <div class="profile-divider"></div>
        <div class="profile-bio">
            <div class="bio-title">Biografia</div>
            <div class="bio-text">{{#if otherUser.description}}{{otherUser.description}}{{else}}Sem descrição.{{/if}}</div>
        </div>
        <div class="profile-tags">
            <div class="profile-tag">Usuário</div>
        </div>
        {{else}}
        <p>Selecione uma conversa para ver o perfil.</p>
        {{/if}}
    </script>

    <!-- Script JS Cliente Corrigido e Refatorado -->
    <script>
      // O código JS permanece o mesmo da versão anterior, pois a correção foi no template HTML/Handlebars
      document.addEventListener("DOMContentLoaded", function() {
        // --- Elementos da DOM ---
        const usersListContainer = document.getElementById("users-list-container");
        const messagesContainer = document.getElementById("messages-container");
        const chatHeaderContainer = document.getElementById("chat-header-container");
        const profileContainer = document.getElementById("profile-column-container");
        const messageInput = document.querySelector(".message-input");
        const sendButton = document.querySelector(".send-button");
        const attachmentButton = document.querySelector(".attachment-button");
        const proposalButton = document.querySelector(".proposal-button");
        const toast = document.getElementById("toast");
        const modal = document.getElementById("proposal-modal");
        const closeModalButton = modal.querySelector(".close-modal");
        const cancelButton = modal.querySelector(".cancel-button");
        const proposalForm = document.getElementById("proposal-form");
        const proposalConversationIdInput = document.getElementById("proposal-conversation-id");
        const loggedInUserIdInput = document.getElementById("loggedInUserId");
        const loadingIndicator = messagesContainer.querySelector(".loading-indicator");

        // --- Templates Handlebars (Client-side) ---
        let messageTemplate, chatHeaderTemplate, profileTemplate;
        try {
            const messageSource = document.getElementById("message-template")?.innerHTML;
            const chatHeaderSource = document.getElementById("chat-header-template")?.innerHTML;
            const profileSource = document.getElementById("profile-template")?.innerHTML;
            
            if (messageSource) messageTemplate = Handlebars.compile(messageSource);
            else console.error("Template 'message-template' não encontrado.");
            if (chatHeaderSource) chatHeaderTemplate = Handlebars.compile(chatHeaderSource);
            else console.error("Template 'chat-header-template' não encontrado.");
            if (profileSource) profileTemplate = Handlebars.compile(profileSource);
            else console.error("Template 'profile-template' não encontrado.");

            // Helpers do Handlebars (Client-side)
            Handlebars.registerHelper("formatTime", function(timestamp) {
                if (!timestamp) return "";
                try { return new Date(timestamp).toLocaleTimeString([], {hour: "2-digit", minute:"2-digit"}); } catch (e) { return ""; }
            });
            // Este formatDate é para o CLIENT-SIDE (JS)
            Handlebars.registerHelper("formatDate", function(timestamp) {
                if (!timestamp) return "";
                try {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (date.toDateString() === now.toDateString()) {
                        return date.toLocaleTimeString([], {hour: "2-digit", minute:"2-digit"});
                    } else if (date.toDateString() === yesterday.toDateString()) {
                        return "Ontem";
                    } else {
                        return date.toLocaleDateString([], {day: "2-digit", month: "2-digit"});
                    }
                } catch (e) { return ""; }
            });
             // Este randomColor é para o CLIENT-SIDE (JS)
            Handlebars.registerHelper("randomColor", function() {
                const colors = ["FFA500", "008000", "FFC0CB", "0000FF", "800080", "FF0000", "4B0082"];
                return colors[Math.floor(Math.random() * colors.length)];
            });

        } catch (e) {
            console.error("Erro ao compilar templates Handlebars:", e);
            showToast("Erro interno ao carregar a interface do chat.", true);
        }

        // --- Estado da Aplicação ---
        let currentChatId = null;
        let currentOtherUserId = null;
        let currentOtherUserName = null;
        let messagesOffset = 0;
        let totalMessages = 0;
        let isLoadingMessages = false;
        const messagesLimit = 30;
        const loggedInUserId = loggedInUserIdInput ? parseInt(loggedInUserIdInput.value, 10) : null;
        let socket = null;

        if (!loggedInUserId) {
            showToast("Erro: Não foi possível identificar o usuário logado.", true);
            disableChatInput();
        }

        // --- Inicialização do Socket.IO ---
        function initializeWebSocket() {
            try {
                socket = io({ transports: ["websocket"] });

                socket.on("connect", () => {
                    console.log("Conectado ao servidor WebSocket:", socket.id);
                    if (currentChatId) {
                        socket.emit("join_chat", currentChatId);
                    }
                });

                socket.on("disconnect", (reason) => {
                    console.log("Desconectado do servidor WebSocket:", reason);
                });

                socket.on("connect_error", (err) => {
                    console.error("Erro de conexão WebSocket:", err);
                    showToast("Falha na conexão em tempo real.", true);
                });

                socket.on("new_message", handleNewMessage);

            } catch (e) {
                console.error("Falha ao inicializar Socket.IO:", e);
                showToast("Não foi possível iniciar o chat em tempo real.", true);
            }
        }

        // --- Funções de Fetch --- 
        async function fetchData(url, options = {}) {
            isLoadingMessages = true;
            try {
                const fetchOptions = { 
                    ...options, 
                    credentials: "include",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        ...(options.headers || {})
                    }
                 }; 
                 if (options.body && typeof options.body !== 'string') {
                     fetchOptions.body = JSON.stringify(options.body);
                 }

                const response = await fetch(url, fetchOptions);
                if (!response.ok) {
                    let errorMsg = `Erro ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || errorMsg;
                    } catch (e) { /* Ignora erro no parse do erro */ }
                    throw new Error(errorMsg);
                }
                if (response.status === 204) return null;
                return await response.json();
            } catch (error) {
                console.error("Fetch error:", url, error);
                showToast(`Erro: ${error.message}`, true);
                return null;
            } finally {
                isLoadingMessages = false;
            }
        }

        // --- Funções de Renderização --- 
        function renderSingleMessage(message, prepend = false) {
            if (!messageTemplate) return;
            message.isCurrentUser = message.userid === loggedInUserId;
            const messageHtml = messageTemplate({ messages: [message] });
            const placeholderP = messagesContainer.querySelector("p");
            if (placeholderP) {
                placeholderP.remove();
            }
            if (prepend) {
                messagesContainer.insertAdjacentHTML('afterbegin', messageHtml);
            } else {
                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            }
        }
        function renderMessageBlock(messages) {
            if (!messageTemplate) return;
            messages.forEach(msg => {
                msg.isCurrentUser = msg.sender && msg.sender.id === loggedInUserId;
            });
            const messagesHtml = messageTemplate({ messages: messages });
            if(loadingIndicator) loadingIndicator.style.display = 'none';
            const oldScrollHeight = messagesContainer.scrollHeight;
            const oldScrollTop = messagesContainer.scrollTop;
            if (loadingIndicator) {
                 loadingIndicator.insertAdjacentHTML('afterend', messagesHtml);
            } else {
                 messagesContainer.insertAdjacentHTML('afterbegin', messagesHtml);
            }
            messagesContainer.scrollTop = oldScrollTop + (messagesContainer.scrollHeight - oldScrollHeight);
        }

        // --- Lógica do Chat ---
        async function loadMessages(chatId, offset = 0) {
            try {
                const response = await fetch(`/api/chats/${chatId}/messages?limit=30&offset=${offset}`);
                if (!response.ok) {
                    throw new Error('Falha ao carregar mensagens via API');
                }
                const data = await response.json();
                console.log('DEBUG: Dados recebidos da API:', data); // LOG PARA DEBUG
                // Atualiza o cabeçalho e perfil com as informações do outro usuário
                if (data.otherUser) {
                    if (chatHeaderTemplate) {
                        document.getElementById('chat-header-container').innerHTML = chatHeaderTemplate({ otherUser: data.otherUser });
                    }
                    if (profileTemplate) {
                        document.getElementById('profile-column-container').innerHTML = profileTemplate({ otherUser: data.otherUser });
                    }
                    enableChatInput();
                } else {
                    // Se não houver outro usuário, desabilita o input e mostra placeholders
                    document.getElementById('chat-header-container').innerHTML = chatHeaderTemplate({});
                    document.getElementById('profile-column-container').innerHTML = profileTemplate({});
                    disableChatInput();
                }
                // Renderiza as mensagens
                if (messageTemplate) {
                    // Corrige o mapeamento para garantir que isCurrentUser funcione
                    const messages = (data.messages || []).map(msg => ({
                        ...msg,
                        isCurrentUser: msg.sender && msg.sender.id === loggedInUserId
                    }));
                    const messagesHtml = messageTemplate({ messages });
                    if (offset === 0) {
                        messagesContainer.innerHTML = messagesHtml;
                    } else {
                        messagesContainer.insertAdjacentHTML('afterbegin', messagesHtml);
                    }
                }
                // Atualiza o total de mensagens
                totalMessages = data.totalMessages || 0;
                // Esconde o indicador de carregamento
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                messagesContainer.innerHTML = '<p class="error-message">Erro ao carregar mensagens. Tente novamente.</p>';
                document.getElementById('chat-header-container').innerHTML = chatHeaderTemplate({});
                document.getElementById('profile-column-container').innerHTML = profileTemplate({});
            }
        }
        function handleNewMessage(newMessage) {
            console.log("Nova mensagem recebida via WS:", newMessage);
            if (newMessage && newMessage.id && newMessage.chatId == currentChatId) {
                renderSingleMessage(newMessage);
                scrollToBottom(messagesContainer);
                updateConversationPreview(currentChatId, newMessage);
            }
        }
        function scrollToBottom(element) {
            setTimeout(() => { element.scrollTop = element.scrollHeight; }, 50);
        }
        function updateChatUI(chatId) {
            // Mostra o indicador de carregamento
            document.querySelector('.loading-indicator').style.display = 'block';
            
            // Limpa as mensagens existentes
            document.querySelector('.messages-container').innerHTML = '';
            
            // Reseta o offset e carrega as mensagens
            currentOffset = 0;
            loadMessages(chatId);
            
            // Atualiza o chat ativo
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.chatId === chatId) {
                    item.classList.add('active');
                }
            });
        }
        function disableChatInput() {
            messageInput.disabled = true;
            sendButton.disabled = true;
            attachmentButton.disabled = true;
            proposalButton.disabled = true;
            messageInput.placeholder = "Selecione uma conversa...";
            const reportBtn = document.querySelector('#chat-header-container .report-button');
            if(reportBtn) reportBtn.disabled = true;
        }
        function enableChatInput() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            attachmentButton.disabled = false;
            proposalButton.disabled = false;
            messageInput.placeholder = "Digite sua mensagem...";
            const reportBtn = document.querySelector('#chat-header-container .report-button');
            if(reportBtn) reportBtn.disabled = false;
            messageInput.focus();
        }
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText || !currentChatId || isLoadingMessages) {
                return;
            }
            const tempId = `temp_${Date.now()}`;
            const optimisticMessage = {
                id: tempId,
                message: messageText,
                createdAt: new Date().toISOString(),
                sender: { id: loggedInUserId, name: "Você" },
                isCurrentUser: true
            };
            renderSingleMessage(optimisticMessage);
            scrollToBottom(messagesContainer);
            messageInput.value = '';
            updateConversationPreview(currentChatId, optimisticMessage);
            const url = `/api/chats/${currentChatId}/messages`;
            const body = { message: messageText };
            const sentMessageData = await fetchData(url, { 
                method: 'POST', 
                body: body 
            });
            if (sentMessageData && sentMessageData.id) {
                console.log("Mensagem enviada com sucesso pela API:", sentMessageData.id);
                const tempMsgElement = messagesContainer.querySelector(`[data-message-id="${tempId}"]`);
                if (tempMsgElement) tempMsgElement.dataset.messageId = sentMessageData.id;
            } else {
                showToast("Erro ao enviar mensagem.", true);
                const failedMsgElement = messagesContainer.querySelector(`[data-message-id="${tempId}"]`);
                if (failedMsgElement) {
                    failedMsgElement.classList.add('error');
                }
            }
            messageInput.focus();
        }
        function updateConversationPreview(chatId, newMessage) {
            const conversationDiv = usersListContainer.querySelector(`.user-conversation[data-chat-id="${chatId}"]`);
            if (conversationDiv) {
                const lastMessageDiv = conversationDiv.querySelector('.last-message');
                const timeDiv = conversationDiv.querySelector('.user-time');
                if (lastMessageDiv) {
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = newMessage.message; 
                    lastMessageDiv.textContent = tempDiv.textContent.substring(0, 50) + (tempDiv.textContent.length > 50 ? '...' : '');
                }
                // Usa o helper do CLIENT-SIDE aqui, pois estamos no JS
                if (timeDiv && Handlebars.helpers.formatDate) {
                     timeDiv.textContent = Handlebars.helpers.formatDate(newMessage.createdAt);
                }
                if (usersListContainer.firstChild !== conversationDiv) {
                    usersListContainer.prepend(conversationDiv);
                }
            }
        }
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = `toast show ${isError ? 'error' : ''}`;
            setTimeout(() => {
                toast.className = toast.className.replace("show", "");
            }, 3000);
        }

        // --- Event Listeners ---
        if (usersListContainer) {
            usersListContainer.addEventListener("click", (event) => {
                const conversation = event.target.closest(".user-conversation");
                if (conversation) {
                    const chatId = conversation.dataset.chatId;
                    const otherUserId = conversation.dataset.otherUserId;
                    const otherUserName = conversation.dataset.otherUserName;
                    if (chatId && otherUserId && otherUserName && chatId !== currentChatId) {
                        if (socket && socket.connected && currentChatId) {
                            socket.emit("leave_chat", currentChatId);
                            console.log(`Saiu da sala WebSocket: ${currentChatId}`);
                        }
                        document.querySelectorAll('.user-conversation.active').forEach(el => el.classList.remove('active'));
                        conversation.classList.add('active');
                        currentChatId = chatId;
                        currentOtherUserId = otherUserId;
                        currentOtherUserName = otherUserName;
                        updateChatUI(chatId);
                    }
                }
            });
        }
        if (sendButton) {
            sendButton.addEventListener("click", sendMessage);
        }
        if (messageInput) {
            messageInput.addEventListener("keypress", (event) => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }
        if (messagesContainer) {
            messagesContainer.addEventListener('scroll', () => {
                if (!isLoadingMessages && messagesContainer.scrollTop < 100 && messagesOffset < totalMessages) {
                    console.log("Scroll perto do topo, carregando mais mensagens...");
                    loadMessages(currentChatId, true);
                }
            });
        }
        if (proposalButton) {
            proposalButton.addEventListener('click', () => {
                if (currentChatId) {
                    proposalConversationIdInput.value = currentChatId;
                    modal.style.display = 'block';
                }
            });
        }
        if (closeModalButton) closeModalButton.addEventListener('click', () => modal.style.display = 'none');
        if (cancelButton) cancelButton.addEventListener('click', () => modal.style.display = 'none');
        if (proposalForm) {
            proposalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Enviando proposta...');
                showToast('Proposta enviada com sucesso!');
                modal.style.display = 'none';
                proposalForm.reset();
            });
        }
        window.addEventListener('click', (event) => {
            if (event.target == modal) modal.style.display = 'none';
        });

        // --- Inicialização ---
        disableChatInput();
        initializeWebSocket();

      });
    </script>

</body>
